# 批量图像生成工具使用说明

## 功能描述
这个工具基于您已经训练好的扩散模型权重，批量生成一排4张医学图像，没有任何标题和边框，输出干净美观的图像。

## 文件说明
- `batch_generate.py` - 完整功能版本
- `simple_generate.py` - 简化版本，推荐使用

## 使用前准备

### 1. 确保有训练好的模型权重
您需要有一个训练好的`.pt`权重文件。脚本会在以下位置查找：
- `./ViTRes1.pt` (当前目录)
- `./checkpoints/ViTRes1.pt` (checkpoints目录)
- `./result/ViTRes1.pt` (result目录)
- `C:/Pan research/Diffusion model/result/ACDC/ViTRes1.pt` (原始训练路径)

### 2. 环境要求
- Python 3.7+
- PyTorch
- MONAI
- matplotlib
- numpy
- 其他依赖见 `requirements.txt`

## 使用方法

### 方法1：使用简化版本（推荐）
```bash
python simple_generate.py
```

### 方法2：使用完整版本
```bash
python batch_generate.py
```

## 输出说明

### 生成的文件
脚本会在 `./generated_images/` 目录下生成：
1. `batch_generated_YYYYMMDD_HHMMSS.png` - 一排4张图像的组合图
2. `single_YYYYMMDD_HHMMSS_1.png` 到 `single_YYYYMMDD_HHMMSS_4.png` - 4张单独的图像

### 图像特点
- **尺寸**: 256x256像素
- **格式**: PNG格式，灰度图像
- **布局**: 一排4张，无边框，无标题
- **间距**: 最小间距，紧凑排列
- **质量**: 150 DPI高质量输出

## 配置选项

### 修改生成数量
如果想生成不同数量的图像，可以修改脚本中的 `BATCH_SIZE` 参数：
```python
BATCH_SIZE = 4  # 改为您想要的数量
```

### 修改权重文件路径
如果您的权重文件在其他位置，修改 `weight_paths` 列表：
```python
weight_paths = [
    "您的权重文件路径.pt",
    # 其他备选路径...
]
```

### 修改输出设置
- 修改输出目录：改变 `output_dir` 变量
- 修改图像尺寸：改变 `figsize` 参数
- 修改DPI：改变 `dpi` 参数

## 性能优化

### GPU加速
- 脚本会自动检测并使用GPU（如果可用）
- 使用50步快速采样（相比训练时的1000步）
- 支持批量生成提高效率

### 时间估算
- GPU环境：约10-30秒生成4张图像
- CPU环境：约2-5分钟生成4张图像

## 故障排除

### 常见问题

1. **找不到权重文件**
   ```
   错误: 找不到权重文件!
   ```
   解决：确保.pt文件存在于指定路径，或修改脚本中的路径

2. **导入模块失败**
   ```
   导入模块失败: No module named 'xxx'
   ```
   解决：检查依赖是否完整安装，运行 `pip install -r requirements.txt`

3. **CUDA内存不足**
   ```
   CUDA out of memory
   ```
   解决：减少批量大小或使用CPU模式

4. **模型权重不匹配**
   ```
   size mismatch for xxx
   ```
   解决：确保权重文件与当前模型架构匹配

### 调试模式
如果遇到问题，可以在脚本开头添加：
```python
import traceback
# 在异常处理中添加
traceback.print_exc()
```

## 输出示例

生成的图像将是一排4张256x256的医学图像，类似于：
```
[图像1] [图像2] [图像3] [图像4]
```

每张图像都是基于扩散模型从噪声生成的全新医学图像，可用于数据增强或研究目的。

## 技术细节

### 模型架构
- 基于Swin Transformer的U-Net架构
- 输入：1通道256x256图像
- 输出：2通道（预测噪声+方差）

### 扩散参数
- 扩散步数：1000（训练）→ 50（推理）
- 噪声调度：线性调度
- 采样方法：DDPM采样

### 图像处理
- 输出范围：[-1, 1] → [0, 1]
- 颜色映射：灰度
- 后处理：裁剪到有效范围

## 自定义扩展

您可以基于这个脚本进行扩展：
- 添加图像后处理
- 修改保存格式
- 添加批量处理功能
- 集成到其他工作流程中